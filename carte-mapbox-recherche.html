<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Carte Mapbox avec sélection des communes et départements</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

  <!-- Inclusion des feuilles de style et scripts Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- Style personnalisé pour la carte -->
  <style>
    body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    .legend {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 4px;
        font-size: 12px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        margin-right: 5px;
    }

  </style>
</head>
<body>

  <!-- Conteneur de la carte -->
  <div id="map"></div>

  <!-- Script principal -->
  <script>
    // Variable globale pour la carte
    let map;

    // Variables pour stocker les sélections
    let selectedFeatures = [];
    let currentLayerType = 'none'; // 'com', 'dep', 'niveauVie', 'logementSocial', 'none', etc.


    // Configuration unifiée de toutes les couches
const layerConfigs = {
    communes: {
        type: 'selectable',
        source: {
            type: 'vector',
            url: 'mapbox://hadrienleger.cya562rc'
        },
        sourceLayer: 'simplifie-fusion-communes-et--439qo9',
        paint: {
            'fill-color': [
                'case',
                ['boolean', ['feature-state', 'selected'], false],
                '#FF0000',
                '#2C3E50'
            ],
            'fill-opacity': 0.8,
            'fill-outline-color': '#FFFFFF'
        },
        labels: {
            enabled: true,
            layout: {
                'text-field': ['get', 'NOM'],
                'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                'text-size': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    5, 8,
                    12, 8
                ],
                'text-anchor': 'center',
                'text-allow-overlap': false
            },
            paint: {
                'text-color': '#FFFFFF',
                'text-halo-color': '#000000',
                'text-halo-width': 1
            },
            minZoom: 8
        },
        interactions: {
            selectable: true,
            idField: 'INSEE_COM',
            specialCases: {
                ids: ['75056', '69123', '13055'],
                alternateField: 'INSEE_ARM'
            },
            cursor: 'pointer',
            bubbleFunction: 'com'
        }
    },
    departements: {
        type: 'selectable',
        source: {
            type: 'vector',
            url: 'mapbox://hadrienleger.7ys4ypx4'
        },
        sourceLayer: 'simplifie-DEPARTEMENT-asio6w',
        paint: {
            'fill-color': [
                'case',
                ['boolean', ['feature-state', 'selected'], false],
                '#FF0000',
                '#8E44AD'
            ],
            'fill-opacity': 0.5,
            'fill-outline-color': '#FFFFFF'
        },
        labels: {
            enabled: true,
            layout: {
                'text-field': [
                    'format',
                    ['get', 'INSEE_DEP'],
                    {},
                    ' ',
                    {},
                    ['get', 'NOM']
                ],
                'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                'text-size': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    5, 10,
                    12, 11
                ],
                'text-anchor': 'center',
                'text-allow-overlap': false
            },
            paint: {
                'text-color': '#FFFFFF',
                'text-halo-color': '#000000',
                'text-halo-width': 1
            },
            minZoom: 5
        },
        interactions: {
            selectable: true,
            idField: 'INSEE_DEP',
            cursor: 'pointer',
            bubbleFunction: 'dep'
        }
    },
    niveauVie: {
        type: 'choropleth',
        source: {
            type: 'vector',
            url: 'mapbox://hadrienleger.filosofi2019'
        },
        sourceLayer: 'hadrienleger.filosofi2019',
        property: 'nv_moyen',
        breaks: [15000, 20000, 25000, 30000, 35000],
        colors: ['#fee5d9', '#fcae91', '#fb6a4a', '#de2d26', '#a50f15', '#67000d'],
        title: 'Niveau de vie médian',
        labels: ['< 15k€', '15-20k€', '20-25k€', '25-30k€', '30-35k€', '> 35k€']
    },
    logementSocial: {
        type: 'choropleth',
        source: {
            type: 'vector',
            url: 'mapbox://hadrienleger.filosofi2019'
        },
        sourceLayer: 'hadrienleger.filosofi2019',
        property: 'part_log_soc',
        breaks: [5, 10, 15, 20, 25],
        colors: ['#eff3ff', '#bdd7e7', '#6baed6', '#3182bd', '#08519c', '#042f6b'],
        title: 'Part de logements sociaux (%)',
        labels: ['< 5%', '5-10%', '10-15%', '15-20%', '20-25%', '> 25%']
    }
};

    // Fonction pour initialiser la carte
    function initializeMap() {
      mapboxgl.accessToken = 'pk.eyJ1IjoiaGFkcmllbmxlZ2VyIiwiYSI6ImNsYm1oc3RidzA1NDczdm1xYTJmc3cwcm4ifQ.AguFBTkyTxFnz3VWFBSjrA'; // Remplacez par votre token Mapbox

      // Création de la carte
       map = new mapboxgl.Map({
         container: 'map',
         style: 'mapbox://styles/mapbox/light-v11',
         center: [2.2137, 46.2276],
         zoom: 5
     });

     map.on('load', function() {
         // Ajouter toutes les sources au chargement
         Object.keys(layerConfigs).forEach(layerId => {
             const config = layerConfigs[layerId];
             if (!map.getSource(layerId)) {
                 map.addSource(layerId, config.source);
             }
         });
         
         // Cacher toutes les couches par défaut
         hideAllLayers();
     });
    }


// Fonction unique pour ajouter une couche
function addLayer(layerId) {
   const config = layerConfigs[layerId];
   if (!config) return;

   // Ajouter la couche selon son type
   switch(config.type) {
       case 'choropleth':
           addChoroplethLayer(layerId, config);
           break;
       case 'selectable':
           addSelectableLayer(layerId, config);
           break;
       case 'simple':
           addSimpleLayer(layerId, config);
           break;
   }
}

function addSelectableLayer(layerId, config) {
   // Ajouter la couche principale
   map.addLayer({
       id: layerId,
       type: 'fill',
       source: layerId,
       'source-layer': config.sourceLayer,
       paint: config.paint
   });

   // Ajouter les interactions
   if (config.interactions?.selectable) {
       map.on('click', layerId, function(e) {
           handleFeatureClick(e, config.interactions.bubbleFunction);
       });

       if (config.interactions.cursor) {
           map.on('mouseenter', layerId, function() {
               map.getCanvas().style.cursor = config.interactions.cursor;
           });

           map.on('mouseleave', layerId, function() {
               map.getCanvas().style.cursor = '';
           });
       }
   }

   // Ajouter les labels si configurés
   if (config.labels?.enabled) {
       map.addLayer({
           id: `${layerId}-labels`,
           type: 'symbol',
           source: layerId,
           'source-layer': config.sourceLayer,
           minzoom: config.labels.minZoom,
           layout: config.labels.layout,
           paint: config.labels.paint
       }, layerId);
   }
}

function addChoroplethLayer(layerId, config) {
   const layerIdFull = `${layerId}-choropleth`;
   
   if (map.getLayer(layerIdFull)) {
       map.removeLayer(layerIdFull);
   }

   const colorExpression = ['step', ['get', config.property]];
   config.breaks.forEach((break_, i) => {
       colorExpression.push(break_);
       colorExpression.push(config.colors[i]);
   });
   colorExpression.push(config.colors[config.colors.length - 1]);

   map.addLayer({
       id: layerIdFull,
       type: 'fill',
       source: layerId,
       'source-layer': config.sourceLayer,
       paint: {
           'fill-color': colorExpression,
           'fill-opacity': 0.7,
           'fill-outline-color': '#ffffff'
       }
   });

   updateLegend(config);
}

function addSimpleLayer(layerId, config) {
   map.addLayer({
       id: layerId,
       type: 'fill',
       source: layerId,
       'source-layer': config.sourceLayer,
       paint: config.paint
   });
}

function handleFeatureClick(e, layerType) {
   if (currentLayerType !== layerType) {
       return;
   }

   var feature = e.features[0];
   var properties = feature.properties;
   var config = layerConfigs[layerType];
   var id;

   if (config.interactions.specialCases?.ids.includes(properties[config.interactions.idField])) {
       id = properties[config.interactions.specialCases.alternateField];
   } else {
       id = properties[config.interactions.idField];
   }

   if (!id) {
       console.error('Identifiant non trouvé pour la feature sélectionnée.');
       return;
   }

   // Gérer la sélection/désélection
   var index = selectedFeatures.indexOf(id);
   if (index > -1) {
       selectedFeatures.splice(index, 1);
       map.setFeatureState(
           { source: layerType, sourceLayer: config.sourceLayer, id: feature.id },
           { selected: false }
       );
   } else {
       selectedFeatures.push(id);
       map.setFeatureState(
           { source: layerType, sourceLayer: config.sourceLayer, id: feature.id },
           { selected: true }
       );
   }

   // Envoyer les données à Bubble
   if (typeof bubble_fn_selectedFeatures === 'function') {
       bubble_fn_selectedFeatures({
           output1: config.interactions.bubbleFunction,
           outputlist1: selectedFeatures
       });
   }
}

function hideAllLayers() {
   // Cacher toutes les couches existantes
   Object.keys(layerConfigs).forEach(layerId => {
       const config = layerConfigs[layerId];
       
       // Cacher la couche principale
       if (map.getLayer(layerId)) {
           map.setLayoutProperty(layerId, 'visibility', 'none');
       }
       
       // Cacher les labels si présents
       if (config.labels?.enabled && map.getLayer(`${layerId}-labels`)) {
           map.setLayoutProperty(`${layerId}-labels`, 'visibility', 'none');
       }
       
       // Cacher les couches choroplèthes
       if (config.type === 'choropleth' && map.getLayer(`${layerId}-choropleth`)) {
           map.setLayoutProperty(`${layerId}-choropleth`, 'visibility', 'none');
       }
   });

   // Cacher la légende
   document.getElementById('legend').style.display = 'none';
}

function updateLegend(config) {
   const legend = document.getElementById('legend');
   legend.innerHTML = `<h4>${config.title}</h4>`;
   
   config.labels.forEach((label, i) => {
       legend.innerHTML += `
           <div class="legend-item">
               <div class="legend-color" style="background: ${config.colors[i]}"></div>
               <span>${label}</span>
           </div>
       `;
   });
   
   legend.style.display = 'block';
}

// Interface avec Bubble
window.updateMapLayers = function(layerType) {
   currentLayerType = layerType;
   selectedFeatures = []; // Réinitialiser les sélections
   
   hideAllLayers();

   // Afficher la couche demandée
   if (layerConfigs[layerType]) {
       addLayer(layerType);

       // Rendre la couche visible
       map.setLayoutProperty(layerType, 'visibility', 'visible');
       
       // Rendre les labels visibles si présents
       if (layerConfigs[layerType].labels?.enabled) {
           map.setLayoutProperty(`${layerType}-labels`, 'visibility', 'visible');
       }
       
       // Rendre la couche choroplèthe visible si applicable
       if (layerConfigs[layerType].type === 'choropleth') {
           map.setLayoutProperty(`${layerType}-choropleth`, 'visibility', 'visible');
       }
   }
};

// Initialiser la carte au chargement
window.onload = initializeMap;


  </script>
</body>
</html>
